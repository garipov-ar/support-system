{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="analytics-dashboard">
    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 40px;">
        <div
            style="flex: 1; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>Активность (запросы в день)</h3>
            <canvas id="interactionsChart"></canvas>
        </div>
        <div
            style="flex: 1; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>Среднее время ответа (мс)</h3>
            <canvas id="responseTimeChart"></canvas>
        </div>
    </div>

    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div
            style="flex: 1; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>Топ-10 поисковых запросов</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #eee; text-align: left;">
                        <th style="padding: 10px;">Запрос</th>
                        <th style="padding: 10px;">Кол-во</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in top_searches %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">{{ item.query_text }}</td>
                        <td style="padding: 10px;">{{ item.count }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" style="padding: 10px;">Данных пока нет</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div
            style="flex: 1; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3>Самые активные пользователи</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #eee; text-align: left;">
                        <th style="padding: 10px;">Пользователь</th>
                        <th style="padding: 10px;">Действий</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in active_users %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">{{ item.name }}</td>
                        <td style="padding: 10px;">{{ item.count }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" style="padding: 10px;">Данных пока нет</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const interactionsCtx = document.getElementById('interactionsChart').getContext('2d');
    new Chart(interactionsCtx, {
        type: 'line',
        data: {
            labels: {{ interactions_labels|safe }},
            datasets: [{
                label: 'Запросы',
                data: {{ interactions_data|safe }},
                borderColor: '#417690',
                backgroundColor: 'rgba(65, 118, 144, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });

    const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
    new Chart(responseTimeCtx, {
        type: 'line',
        data: {
            labels: {{ avg_time_labels|safe }},
            datasets: [{
                label: 'Среднее время (мс)',
                data: {{ avg_time_data|safe }},
                borderColor: '#f5dd5d',
                backgroundColor: 'rgba(245, 221, 93, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
{% endblock %}